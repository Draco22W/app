<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ ç«æŸ´äººæ‰“æ–—æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            cursor: crosshair;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .health-bars {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .health-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 8px;
            position: relative;
        }

        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: healthShine 2s infinite;
        }

        @keyframes healthShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .player1-health .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #ff4757);
        }

        .player2-health .health-fill {
            background: linear-gradient(90deg, #3742fa, #00d2ff);
        }

        .health-text {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0 10px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #fff;
            font-size: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .controls h3 {
            margin-bottom: 8px;
            color: #ffd700;
        }

        .controls p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .skill-cooldowns {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .skill-cooldown {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .skill-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }

        .skill-icon.dart {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
        }

        .skill-icon.teleport {
            background: linear-gradient(45deg, #3742fa, #00d2ff);
        }

        .cooldown-bar {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .cooldown-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.1s linear;
            border-radius: 3px;
        }

        .settings-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            backdrop-filter: blur(20px);
            display: none;
            pointer-events: auto;
            min-width: 300px;
        }

        .settings-menu h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .setting-item {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            color: #fff;
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #444;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #ffd700;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .difficulty-select {
            background: #333;
            color: #fff;
            border: 1px solid #ffd700;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
            transition: transform 0.2s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            text-align: center;
            display: none;
            pointer-events: auto;
        }

        .game-over h2 {
            color: #ffd700;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .game-over p {
            color: #fff;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            display: block;
            pointer-events: auto;
        }

        .start-screen h1 {
            font-size: 48px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .start-screen p {
            font-size: 18px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .start-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .start-btn:hover {
            transform: scale(1.1);
        }

        .damage-text {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: particleExplode 0.8s ease-out forwards;
        }

        @keyframes particleExplode {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0) translate(var(--dx), var(--dy));
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div class="ui-overlay">
        <div class="health-bars">
            <div class="health-text">ç©å®¶</div>
            <div class="health-bar player1-health">
                <div class="health-fill" style="width: 100%"></div>
            </div>
            <div class="health-text">AI</div>
            <div class="health-bar player2-health">
                <div class="health-fill" style="width: 100%"></div>
            </div>
        </div>

        <div class="controls">
            <h3>ğŸ® æ“ä½œè¯´æ˜</h3>
            <p><strong>W</strong> - è·³è·ƒ</p>
            <p><strong>A/D</strong> - å·¦å³ç§»åŠ¨</p>
            <p><strong>I</strong> - é£é•–æ”»å‡»</p>
            <p><strong>O</strong> - ç¬ç§»æŠ€èƒ½</p>
            <p><strong>ESC</strong> - è®¾ç½®èœå•</p>
        </div>

        <div class="skill-cooldowns">
            <div class="skill-cooldown">
                <div class="skill-icon dart">I</div>
                <div class="cooldown-bar">
                    <div class="cooldown-fill" style="width: 100%"></div>
                </div>
            </div>
            <div class="skill-cooldown">
                <div class="skill-icon teleport">O</div>
                <div class="cooldown-bar">
                    <div class="cooldown-fill" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="settings-menu">
            <h2>âš™ï¸ æ¸¸æˆè®¾ç½®</h2>
            <div class="setting-item">
                <label>éŸ³æ•ˆ</label>
                <div class="toggle-switch" id="soundToggle"></div>
            </div>
            <div class="setting-item">
                <label>éŸ³ä¹</label>
                <div class="toggle-switch" id="musicToggle"></div>
            </div>
            <div class="setting-item">
                <label>AIéš¾åº¦</label>
                <select class="difficulty-select" id="difficultySelect">
                    <option value="easy">ç®€å•</option>
                    <option value="normal" selected>æ™®é€š</option>
                    <option value="hard">å›°éš¾</option>
                </select>
            </div>
            <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
        </div>

        <div class="game-over">
            <h2 id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
            <p id="gameOverMessage">è·èƒœè€…</p>
            <button class="restart-btn" onclick="restartGame()">å†æ¥ä¸€å±€</button>
        </div>

        <div class="start-screen" id="startScreen">
            <h1>ğŸ”¥ ç«æŸ´äººæ‰“æ–—</h1>
            <p>ä½¿ç”¨WASDç§»åŠ¨ï¼ŒIé”®é£é•–ï¼ŒOé”®ç¬ç§»</p>
            <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <!-- éŸ³é¢‘èµ„æº -->
    <audio id="bgm" src="audio/audio/ç«æŸ´äººå¤§æˆ˜.mp3" loop></audio>
    <audio id="hitSound" src="audio/audio/hit.mp3"></audio>
    <audio id="healSound" src="audio/audio/gold.mp3"></audio>
    <audio id="laserSound" src="audio/audio/go.mp3"></audio>
    <audio id="comboSound" src="audio/audio/gold.mp3"></audio>
    <audio id="cooldownSound" src="audio/audio/tick.mp3"></audio>
    <audio id="victorySound" src="audio/audio/win.mp3"></audio>
    <audio id="failSound" src="audio/audio/timeout.mp3"></audio>

    <script>
        // æ¸¸æˆé…ç½®
        const GAME_CONFIG = {
            width: window.innerWidth,
            height: window.innerHeight,
            gravity: 0.8,
            groundY: window.innerHeight - 100,
            playerSpeed: 4,
            runSpeed: 6,
            jumpPower: 15,
            dartSpeed: 8,
            dartDamage: 15,
            meleeDamage: 10,
            teleportDistance: 100,
            ultimateCooldown: 2400, // 40ç§’å†·å´
            ultimateDuration: 300, // 5ç§’æ— æ•Œæ—¶é—´
            laserDamage: 25
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            isRunning: false,
            isPaused: false,
            gameOver: false,
            winner: null,
            settings: {
                sound: true,
                music: true,
                difficulty: 'normal'
            }
        };

        // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            GAME_CONFIG.width = window.innerWidth;
            GAME_CONFIG.height = window.innerHeight;
            GAME_CONFIG.groundY = window.innerHeight - 100;
        }

        // ç©å®¶ç±»
        class Player {
            constructor(x, y, color, isAI = false) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 60;
                this.color = color;
                this.isAI = isAI;
                this.health = 100;
                this.maxHealth = 100;
                this.velocityX = 0;
                this.velocityY = 0;
                this.onGround = false;
                this.facingRight = !isAI;
                this.attacking = false;
                this.attackCooldown = 0;
                this.dartCooldown = 0;
                this.teleportCooldown = 0;
                this.ultimateCooldown = 0;
                this.ultimateActive = false;
                this.ultimateTimer = 0;
                this.ultimatePhase = 0; // 0: æœªæ¿€æ´», 1: æ— æ•ŒçŠ¶æ€, 2: æ¿€å…‰çŠ¶æ€
                this.animationFrame = 0;
                this.isRunning = false;
                this.isJumping = false;
                this.hitFlash = 0;
                this.lastAction = 0;
                this.aiState = 'idle';
                this.aiTimer = 0;
                this.targetX = x;
            }

            update() {
                // æ›´æ–°åŠ¨ç”»å¸§
                this.animationFrame++;
                
                // åº”ç”¨é‡åŠ›
                if (!this.onGround) {
                    this.velocityY += GAME_CONFIG.gravity;
                }

                // æ›´æ–°ä½ç½®
                this.x += this.velocityX;
                this.y += this.velocityY;

                // åœ°é¢ç¢°æ’æ£€æµ‹
                if (this.y >= GAME_CONFIG.groundY - this.height) {
                    this.y = GAME_CONFIG.groundY - this.height;
                    this.velocityY = 0;
                    this.onGround = true;
                    this.isJumping = false;
                }

                // è¾¹ç•Œæ£€æµ‹
                if (this.x < 0) this.x = 0;
                if (this.x > GAME_CONFIG.width - this.width) {
                    this.x = GAME_CONFIG.width - this.width;
                }

                // æ›´æ–°å†·å´æ—¶é—´
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.dartCooldown > 0) this.dartCooldown--;
                if (this.teleportCooldown > 0) this.teleportCooldown--;
                if (this.ultimateCooldown > 0) this.ultimateCooldown--;

                // æ›´æ–°å¤§æ‹›çŠ¶æ€
                if (this.ultimateActive) {
                    this.ultimateTimer--;
                    if (this.ultimateTimer <= 0) {
                        this.ultimateActive = false;
                        this.ultimatePhase = 0;
                    }
                }

                // æ›´æ–°å—å‡»é—ªçƒ
                if (this.hitFlash > 0) this.hitFlash--;

                // AIè¡Œä¸º
                if (this.isAI) {
                    this.updateAI();
                }

                // æ›´æ–°ç§»åŠ¨çŠ¶æ€
                this.isRunning = Math.abs(this.velocityX) > 0;
            }

            updateAI() {
                const player = gameState.isRunning ? players[0] : null;
                if (!player) return;

                this.aiTimer++;

                // æ ¹æ®éš¾åº¦è°ƒæ•´AIè¡Œä¸º
                const difficulty = gameState.settings.difficulty;
                let reactionTime = 30;
                let skillChance = 0.1;

                switch (difficulty) {
                    case 'easy':
                        reactionTime = 60;
                        skillChance = 0.05;
                        break;
                    case 'hard':
                        reactionTime = 15;
                        skillChance = 0.2;
                        break;
                }

                // è·ç¦»è®¡ç®—
                const distance = Math.abs(this.x - player.x);
                const direction = this.x < player.x ? 1 : -1;

                // AIçŠ¶æ€æœº
                switch (this.aiState) {
                    case 'idle':
                        if (this.aiTimer > reactionTime) {
                            this.aiState = 'approach';
                            this.aiTimer = 0;
                        }
                        break;

                    case 'approach':
                        // æ¥è¿‘ç©å®¶
                        this.velocityX = direction * GAME_CONFIG.playerSpeed;
                        this.facingRight = direction > 0;

                        // å¦‚æœè·ç¦»åˆé€‚ï¼Œåˆ‡æ¢åˆ°æ”»å‡»çŠ¶æ€
                        if (distance < 150 && distance > 50) {
                            this.aiState = 'attack';
                            this.aiTimer = 0;
                        }

                        // éšæœºè·³è·ƒ
                        if (Math.random() < 0.02 && this.onGround) {
                            this.jump();
                        }

                        // éšæœºä½¿ç”¨æŠ€èƒ½
                        if (Math.random() < skillChance) {
                            if (this.dartCooldown === 0 && distance > 80) {
                                this.shootDart();
                            } else if (this.teleportCooldown === 0) {
                                this.teleport();
                            }
                        }
                        break;

                    case 'attack':
                        // æ”»å‡»è¡Œä¸º
                        if (distance < 50) {
                            this.attack();
                        } else if (distance > 200) {
                            this.aiState = 'approach';
                        } else {
                            // ä¿æŒè·ç¦»
                            if (distance < 80) {
                                this.velocityX = -direction * GAME_CONFIG.playerSpeed;
                            } else if (distance > 120) {
                                this.velocityX = direction * GAME_CONFIG.playerSpeed;
                            }
                        }

                        // éšæœºè·³è·ƒèº²é¿
                        if (Math.random() < 0.03 && this.onGround) {
                            this.jump();
                        }

                        this.aiTimer++;
                        if (this.aiTimer > 120) {
                            this.aiState = 'idle';
                            this.aiTimer = 0;
                        }
                        break;
                }

                // èº²é¿é£é•–
                darts.forEach(dart => {
                    if (dart.owner !== this && Math.abs(dart.x - this.x) < 100 && Math.abs(dart.y - this.y) < 50) {
                        if (this.onGround && Math.random() < 0.1) {
                            this.jump();
                        }
                    }
                });
            }

            jump() {
                if (this.onGround) {
                    this.velocityY = -GAME_CONFIG.jumpPower;
                    this.onGround = false;
                    this.isJumping = true;
                }
            }

            attack() {
                if (this.attackCooldown === 0) {
                    this.attacking = true;
                    this.attackCooldown = 20;

                    // æ£€æµ‹æ”»å‡»ç¢°æ’
                    const target = this.isAI ? players[0] : players[1];
                    const distance = Math.abs(this.x - target.x);
                    const direction = this.facingRight ? 1 : -1;
                    const attackRange = 60;

                    if (distance < attackRange && 
                        ((direction > 0 && target.x > this.x) || (direction < 0 && target.x < this.x))) {
                        this.dealDamage(target, GAME_CONFIG.meleeDamage);
                    }

                    setTimeout(() => {
                        this.attacking = false;
                    }, 200);
                }
            }

            shootDart() {
                if (this.dartCooldown === 0) {
                    const direction = this.facingRight ? 1 : -1;
                    const damage = this.ultimateActive && this.ultimatePhase === 1 ? 
                        GAME_CONFIG.dartDamage * 1.5 : GAME_CONFIG.dartDamage;
                    const dart = new Dart(
                        this.x + (this.facingRight ? this.width : 0),
                        this.y + this.height / 2,
                        direction,
                        this,
                        damage
                    );
                    darts.push(dart);
                    this.dartCooldown = 60; // 1ç§’å†·å´
                }
            }

            teleport() {
                if (this.teleportCooldown === 0) {
                    const direction = this.facingRight ? 1 : -1;
                    const newX = this.x + direction * GAME_CONFIG.teleportDistance;
                    
                    if (newX >= 0 && newX <= GAME_CONFIG.width - this.width) {
                        this.x = newX;
                        createTeleportEffect(this.x, this.y);
                    }
                    
                    this.teleportCooldown = 120; // 2ç§’å†·å´
                }
            }

            ultimate() {
                if (this.ultimateCooldown === 0) {
                    if (this.ultimatePhase === 0) {
                        // ç¬¬ä¸€é˜¶æ®µï¼šæ¿€æ´»æ— æ•ŒçŠ¶æ€
                        this.ultimateActive = true;
                        this.ultimatePhase = 1;
                        this.ultimateTimer = GAME_CONFIG.ultimateDuration;
                        createUltimateEffect(this.x, this.y);
                    } else if (this.ultimatePhase === 1) {
                        // ç¬¬äºŒé˜¶æ®µï¼šå‘å°„æ¿€å…‰
                        this.ultimatePhase = 2;
                        this.shootLaser();
                        this.ultimateActive = false;
                        this.ultimateCooldown = GAME_CONFIG.ultimateCooldown;
                    }
                }
            }

            shootLaser() {
                const direction = this.facingRight ? 1 : -1;
                const laser = new Laser(
                    this.x + (this.facingRight ? this.width : 0),
                    this.y + this.height / 2,
                    direction,
                    this
                );
                lasers.push(laser);
            }

            dealDamage(target, damage) {
                // æ£€æŸ¥æ— æ•ŒçŠ¶æ€
                if (target.ultimateActive && target.ultimatePhase === 1) {
                    return; // æ— æ•ŒçŠ¶æ€ä¸å—ä¼¤å®³
                }

                target.health = Math.max(0, target.health - damage);
                target.hitFlash = 10;
                
                // åˆ›å»ºä¼¤å®³æ•°å­—
                createDamageText(target.x + target.width / 2, target.y, damage);
                
                // åˆ›å»ºç²’å­æ•ˆæœ
                createParticleExplosion(target.x + target.width / 2, target.y + target.height / 2);
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸ
                if (target.health <= 0) {
                    gameState.gameOver = true;
                    gameState.winner = this.isAI ? 'AI' : 'ç©å®¶';
                    showGameOver();
                }
            }

            draw() {
                ctx.save();
                
                // å—å‡»é—ªçƒæ•ˆæœ
                if (this.hitFlash > 0) {
                    ctx.globalAlpha = 0.5;
                }

                // æ— æ•ŒçŠ¶æ€æ•ˆæœ
                if (this.ultimateActive && this.ultimatePhase === 1) {
                    ctx.strokeStyle = '#ffd700';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.8;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 25, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // è®¡ç®—åŠ¨ç”»è§’åº¦
                let armAngle = 0;
                let legAngle = 0;

                // å¥”è·‘åŠ¨ç”»
                if (this.isRunning) {
                    armAngle = Math.sin(this.animationFrame * 0.3) * 0.5;
                    legAngle = Math.sin(this.animationFrame * 0.4) * 0.6;
                }

                // è·³è·ƒåŠ¨ç”»
                if (this.isJumping) {
                    legAngle = Math.PI / 6;
                }

                // æ”»å‡»åŠ¨ç”»
                if (this.attacking) {
                    armAngle = Math.PI / 4;
                }

                // ç»˜åˆ¶ç«æŸ´äºº
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                // å¤´éƒ¨
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + 10, 8, 0, Math.PI * 2);
                ctx.stroke();

                // èº«ä½“
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 18);
                ctx.lineTo(this.x + this.width / 2, this.y + 45);
                ctx.stroke();

                // æ‰‹è‡‚
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 25);
                ctx.lineTo(this.x + this.width / 2 + Math.cos(armAngle) * 15, this.y + 25 + Math.sin(armAngle) * 15);
                ctx.moveTo(this.x + this.width / 2, this.y + 25);
                ctx.lineTo(this.x + this.width / 2 - Math.cos(armAngle) * 15, this.y + 25 - Math.sin(armAngle) * 15);
                ctx.stroke();

                // è…¿éƒ¨
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 45);
                ctx.lineTo(this.x + this.width / 2 + Math.cos(legAngle) * 15, this.y + 45 + Math.sin(legAngle) * 15);
                ctx.moveTo(this.x + this.width / 2, this.y + 45);
                ctx.lineTo(this.x + this.width / 2 - Math.cos(legAngle) * 15, this.y + 45 - Math.sin(legAngle) * 15);
                ctx.stroke();

                ctx.restore();
            }
        }

        // é£é•–ç±»
        class Dart {
            constructor(x, y, direction, owner, damage = GAME_CONFIG.dartDamage) {
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.owner = owner;
                this.damage = damage;
                this.speed = GAME_CONFIG.dartSpeed;
                this.width = 8;
                this.height = 8;
            }

            update() {
                this.x += this.direction * this.speed;

                // æ£€æŸ¥è¾¹ç•Œ
                if (this.x < 0 || this.x > GAME_CONFIG.width) {
                    return false;
                }

                // æ£€æŸ¥ç¢°æ’
                const target = this.owner.isAI ? players[0] : players[1];
                if (this.checkCollision(target)) {
                    this.owner.dealDamage(target, this.damage);
                    return false;
                }

                // éšœç¢ç‰©ç¢°æ’
                for (let o of obstacles) {
                    if (this.x < o.x + o.width && this.x + this.width > o.x && this.y < o.y + o.height && this.y + this.height > o.y) {
                        return false;
                    }
                }

                return true;
            }

            checkCollision(target) {
                return this.x < target.x + target.width &&
                       this.x + this.width > target.x &&
                       this.y < target.y + target.height &&
                       this.y + this.height > target.y;
            }

            draw() {
                ctx.save();
                ctx.fillStyle = this.owner.isAI ? '#3742fa' : '#ff6b6b';
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // é£é•–è½¨è¿¹
                ctx.strokeStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + this.height / 2);
                ctx.lineTo(this.x + this.width / 2 - this.direction * 20, this.y + this.height / 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        // æ¿€å…‰ç±»
        class Laser {
            constructor(x, y, direction, owner) {
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.owner = owner;
                this.speed = 15;
                this.width = 6;
                this.height = 6;
                this.life = 60; // 1ç§’æŒç»­æ—¶é—´
            }

            update() {
                this.x += this.direction * this.speed;
                this.life--;

                // æ£€æŸ¥è¾¹ç•Œ
                if (this.x < 0 || this.x > GAME_CONFIG.width || this.life <= 0) {
                    return false;
                }

                // æ£€æŸ¥ç¢°æ’
                const target = this.owner.isAI ? players[0] : players[1];
                if (this.checkCollision(target)) {
                    this.owner.dealDamage(target, GAME_CONFIG.laserDamage);
                    return false;
                }

                // éšœç¢ç‰©ç¢°æ’
                for (let o of obstacles) {
                    if (this.x < o.x + o.width && this.x + this.width > o.x && this.y < o.y + o.height && this.y + this.height > o.y) {
                        return false;
                    }
                }

                return true;
            }

            checkCollision(target) {
                return this.x < target.x + target.width &&
                       this.x + this.width > target.x &&
                       this.y < target.y + target.height &&
                       this.y + this.height > target.y;
            }

            draw() {
                ctx.save();
                
                // æ¿€å…‰æ ¸å¿ƒ
                ctx.fillStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // æ¿€å…‰å…‰ç¯
                ctx.strokeStyle = this.owner.isAI ? '#3742fa' : '#ff6b6b';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 8, 0, Math.PI * 2);
                ctx.stroke();
                
                // æ¿€å…‰è½¨è¿¹
                ctx.strokeStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + this.height / 2);
                ctx.lineTo(this.x + this.width / 2 - this.direction * 50, this.y + this.height / 2);
                ctx.stroke();
                
                ctx.restore();
            }
        }

        // æ¸¸æˆå¯¹è±¡
        let players = [];
        let darts = [];
        let lasers = [];
        let obstacles = [];
        let healItems = [];
        let damageTexts = [];
        let particles = [];

        // éšœç¢ç‰©ç±»
        class Obstacle {
            constructor(x, y, w, h, color) {
                this.x = x;
                this.y = y;
                this.width = w;
                this.height = h;
                this.color = color;
            }
            draw() {
                ctx.save();
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.restore();
            }
        }

        // è¡€åŒ…ç±»
        class HealItem {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 16;
                this.life = 600; // 10ç§’
            }
            update() {
                this.life--;
                return this.life > 0;
            }
            draw() {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#4efc4e';
                ctx.shadowColor = '#fff';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.fillText('+30', this.x, this.y + 5);
                ctx.restore();
            }
        }

        // éšœç¢ç‰©ç”Ÿæˆå‡½æ•°
        function createObstacles() {
            obstacles = [];
            // ç”Ÿæˆ3-5ä¸ªéšœç¢ç‰©
            let count = 3 + Math.floor(Math.random() * 3);
            for (let i = 0; i < count; i++) {
                let w = 60 + Math.random() * 60;
                let h = 30 + Math.random() * 30;
                let x = 100 + Math.random() * (GAME_CONFIG.width - 200 - w);
                let y = GAME_CONFIG.groundY - h - Math.random() * 120;
                let color = `hsl(${Math.random()*360},80%,60%)`;
                obstacles.push(new Obstacle(x, y, w, h, color));
            }
        }

        // è¡€åŒ…ç”Ÿæˆå‡½æ•°
        function createHealItem() {
            let x = 80 + Math.random() * (GAME_CONFIG.width - 160);
            let y = GAME_CONFIG.groundY - 30 - Math.random() * 100;
            healItems.push(new HealItem(x, y));
        }

        // åˆ›å»ºç©å®¶
        function createPlayers() {
            players = [
                new Player(100, GAME_CONFIG.groundY - 60, '#ff6b6b', false),
                new Player(GAME_CONFIG.width - 130, GAME_CONFIG.groundY - 60, '#3742fa', true)
            ];
            createObstacles();
            healItems = [];
        }

        // åˆ›å»ºä¼¤å®³æ•°å­—
        function createDamageText(x, y, damage) {
            const text = {
                x: x,
                y: y,
                damage: damage,
                life: 60,
                velocityY: -2
            };
            damageTexts.push(text);
        }

        // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
        function createParticleExplosion(x, y) {
            for (let i = 0; i < 8; i++) {
                const angle = (Math.PI * 2 * i) / 8;
                const speed = 3 + Math.random() * 2;
                const particle = {
                    x: x,
                    y: y,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 30 + Math.random() * 30,
                    maxLife: 60
                };
                particles.push(particle);
            }
        }

        // åˆ›å»ºç¬ç§»æ•ˆæœ
        function createTeleportEffect(x, y) {
            for (let i = 0; i < 12; i++) {
                const angle = (Math.PI * 2 * i) / 12;
                const speed = 2 + Math.random() * 3;
                const particle = {
                    x: x + 15,
                    y: y + 30,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 20 + Math.random() * 20,
                    maxLife: 40,
                    color: '#00d2ff'
                };
                particles.push(particle);
            }
        }

        // åˆ›å»ºå¤§æ‹›æ•ˆæœ
        function createUltimateEffect(x, y) {
            for (let i = 0; i < 20; i++) {
                const angle = (Math.PI * 2 * i) / 20;
                const speed = 3 + Math.random() * 4;
                const particle = {
                    x: x + 15,
                    y: y + 30,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 30 + Math.random() * 30,
                    maxLife: 60,
                    color: '#ffd700'
                };
                particles.push(particle);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°è¡€é‡æ¡
            const player1Health = document.querySelector('.player1-health .health-fill');
            const player2Health = document.querySelector('.player2-health .health-fill');
            
            if (players[0] && player1Health) {
                player1Health.style.width = (players[0].health / players[0].maxHealth * 100) + '%';
            }
            if (players[1] && player2Health) {
                player2Health.style.width = (players[1].health / players[1].maxHealth * 100) + '%';
            }

            // æ›´æ–°æŠ€èƒ½å†·å´
            const dartCooldown = document.querySelector('.skill-cooldown:nth-child(1) .cooldown-fill');
            const teleportCooldown = document.querySelector('.skill-cooldown:nth-child(2) .cooldown-fill');
            const ultimateCooldown = document.querySelector('.skill-cooldown:nth-child(3) .cooldown-fill');
            
            if (players[0]) {
                const dartPercent = Math.max(0, (60 - players[0].dartCooldown) / 60 * 100);
                const teleportPercent = Math.max(0, (120 - players[0].teleportCooldown) / 120 * 100);
                const ultimatePercent = Math.max(0, (GAME_CONFIG.ultimateCooldown - players[0].ultimateCooldown) / GAME_CONFIG.ultimateCooldown * 100);
                
                if (dartCooldown) dartCooldown.style.width = dartPercent + '%';
                if (teleportCooldown) teleportCooldown.style.width = teleportPercent + '%';
                if (ultimateCooldown) ultimateCooldown.style.width = ultimatePercent + '%';
            }
        }

        // ç»˜åˆ¶åœ°é¢
        function drawGround() {
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, GAME_CONFIG.groundY, GAME_CONFIG.width, GAME_CONFIG.height - GAME_CONFIG.groundY);
            
            // åœ°é¢çº¹ç†
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 1;
            for (let i = 0; i < GAME_CONFIG.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, GAME_CONFIG.groundY);
                ctx.lineTo(i, GAME_CONFIG.height);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶ç²’å­
        function drawParticles() {
            particles.forEach((particle, index) => {
                particle.x += particle.velocityX;
                particle.y += particle.velocityY;
                particle.life--;

                if (particle.life <= 0) {
                    particles.splice(index, 1);
                    return;
                }

                const alpha = particle.life / particle.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = particle.color || '#ffd700';
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // ç»˜åˆ¶ä¼¤å®³æ•°å­—
        function drawDamageTexts() {
            damageTexts.forEach((text, index) => {
                text.y += text.velocityY;
                text.life--;

                if (text.life <= 0) {
                    damageTexts.splice(index, 1);
                    return;
                }

                const alpha = text.life / 60;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = '#ff4757';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text.damage.toString(), text.x, text.y);
                ctx.restore();
            });
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.isRunning || gameState.isPaused) return;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);

            // ç»˜åˆ¶èƒŒæ™¯
            drawGround();

            // æ›´æ–°å’Œç»˜åˆ¶ç©å®¶
            players.forEach(player => {
                player.update();
                player.draw();
            });

            // æ£€æŸ¥ç¢°æ’
            checkCollisions();

            // æ›´æ–°å’Œç»˜åˆ¶é£é•–
            darts = darts.filter(dart => dart.update());
            darts.forEach(dart => dart.draw());

            // æ›´æ–°å’Œç»˜åˆ¶æ¿€å…‰
            lasers = lasers.filter(laser => laser.update());
            lasers.forEach(laser => laser.draw());

            // ç»˜åˆ¶éšœç¢ç‰©å’Œè¡€åŒ…
            obstacles.forEach(o => o.draw());
            healItems = healItems.filter(item => item.update());
            healItems.forEach(item => item.draw());

            // ç»˜åˆ¶ç²’å­æ•ˆæœ
            drawParticles();

            // ç»˜åˆ¶ä¼¤å®³æ•°å­—
            drawDamageTexts();

            // æ›´æ–°UI
            updateUI();

            // ç»§ç»­å¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        // é”®ç›˜æ§åˆ¶
        const keys = {};

        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;

            if (e.key === 'Escape') {
                toggleSettings();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // å¤„ç†ç©å®¶è¾“å…¥
        function handleInput() {
            if (!gameState.isRunning || !players[0]) return;

            const player = players[0];

            // ç§»åŠ¨æ§åˆ¶
            if (keys['a']) {
                player.velocityX = -GAME_CONFIG.playerSpeed;
                player.facingRight = false;
            } else if (keys['d']) {
                player.velocityX = GAME_CONFIG.playerSpeed;
                player.facingRight = true;
            } else {
                player.velocityX = 0;
            }

            // å¥”è·‘
            if (keys['a'] || keys['d']) {
                player.velocityX *= 1.5;
            }

            // è·³è·ƒ
            if (keys['w']) {
                player.jump();
            }

            // æ”»å‡»
            if (keys[' ']) {
                player.attack();
            }

            // æŠ€èƒ½
            if (keys['i']) {
                player.shootDart();
            }

            if (keys['o']) {
                player.teleport();
            }

            if (keys['p']) {
                player.ultimate();
            }
        }

        // è®¾ç½®èœå•æ§åˆ¶
        function toggleSettings() {
            const settingsMenu = document.querySelector('.settings-menu');
            if (settingsMenu.style.display === 'block') {
                settingsMenu.style.display = 'none';
                gameState.isPaused = false;
            } else {
                settingsMenu.style.display = 'block';
                gameState.isPaused = true;
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸ
        function showGameOver() {
            const gameOver = document.querySelector('.game-over');
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');

            title.textContent = 'æ¸¸æˆç»“æŸ';
            message.textContent = `${gameState.winner} è·èƒœï¼`;

            gameOver.style.display = 'block';
            gameState.isPaused = true;
            slowMotion(); // æ¸¸æˆç»“æŸæ—¶æ…¢åŠ¨ä½œ
            if (gameState.winner !== 'ç©å®¶') playSound('failSound');
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameState.isRunning = true;
            gameState.gameOver = false;
            gameState.winner = null;
            
            createPlayers();
            darts = [];
            lasers = [];
            damageTexts = [];
            particles = [];
            
            gameLoop();
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            document.querySelector('.settings-menu').style.display = 'none';
            document.querySelector('.game-over').style.display = 'none';
            
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.gameOver = false;
            gameState.winner = null;
            
            createPlayers();
            darts = [];
            lasers = [];
            damageTexts = [];
            particles = [];
            
            gameLoop();
        }

        // è®¾ç½®åˆ‡æ¢
        document.getElementById('soundToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            gameState.settings.sound = this.classList.contains('active');
            setVolume(gameState.settings.sound ? 1 : 0); // æ ¹æ®éŸ³æ•ˆå¼€å…³è°ƒæ•´éŸ³é‡
        });

        document.getElementById('musicToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            gameState.settings.music = this.classList.contains('active');
            setVolume(gameState.settings.music ? 1 : 0); // æ ¹æ®éŸ³ä¹å¼€å…³è°ƒæ•´éŸ³é‡
        });

        document.getElementById('difficultySelect').addEventListener('change', function() {
            gameState.settings.difficulty = this.value;
        });

        // åˆå§‹åŒ–è®¾ç½®
        document.getElementById('soundToggle').classList.add('active');
        document.getElementById('musicToggle').classList.add('active');

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', resizeCanvas);

        // åˆå§‹åŒ–
        resizeCanvas();

        // è¾“å…¥å¤„ç†å¾ªç¯
        setInterval(handleInput, 16);

        // è¿å‡»å¥–åŠ±
        let comboCount = 0;
        let comboTimer = 0;
        let comboActive = false;
        function onComboHit() {
            comboCount++;
            comboTimer = 120;
            if (comboCount >= 3 && !comboActive) {
                comboActive = true;
                createDamageText(players[0].x + players[0].width/2, players[0].y - 30, 'è¿å‡»!');
                playSound('comboSound');
            }
        }
        setInterval(() => {
            if (comboTimer > 0) comboTimer--;
            else {
                comboCount = 0;
                comboActive = false;
            }
        }, 1000/60);

        // ç©å®¶/AIä¸éšœç¢ç‰©/è¡€åŒ…ç¢°æ’æ£€æµ‹
        function checkCollisions() {
            // ç©å®¶/AIä¸éšœç¢ç‰©
            players.forEach(p => {
                obstacles.forEach(o => {
                    if (p.x + p.width > o.x && p.x < o.x + o.width && p.y + p.height > o.y && p.y < o.y + o.height) {
                        // ç®€å•åå¼¹
                        if (p.x < o.x) p.x = o.x - p.width;
                        else if (p.x > o.x) p.x = o.x + o.width;
                    }
                });
            });
            // ç©å®¶/AIä¸è¡€åŒ…
            players.forEach(p => {
                healItems.forEach((item, idx) => {
                    let dx = p.x + p.width/2 - item.x;
                    let dy = p.y + p.height/2 - item.y;
                    if (dx*dx + dy*dy < (item.radius+20)*(item.radius+20)) {
                        p.health = Math.min(p.maxHealth, p.health + 30);
                        createParticleExplosion(item.x, item.y);
                        playSound('healSound');
                        healItems.splice(idx, 1);
                    }
                });
            });
        }

        // é£é•–/æ¿€å…‰ä¸éšœç¢ç‰©ç¢°æ’
        Dart.prototype.update = function() {
            this.x += this.direction * this.speed;
            // éšœç¢ç‰©ç¢°æ’
            for (let o of obstacles) {
                if (this.x < o.x + o.width && this.x + this.width > o.x && this.y < o.y + o.height && this.y + this.height > o.y) {
                    return false;
                }
            }
            // æ£€æŸ¥ç¢°æ’
            const target = this.owner.isAI ? players[0] : players[1];
            if (this.checkCollision(target)) {
                this.owner.dealDamage(target, this.damage);
                return false;
            }

            return true;
        }
        Laser.prototype.update = function() {
            this.x += this.direction * this.speed;
            this.life--;
            for (let o of obstacles) {
                if (this.x < o.x + o.width && this.x + this.width > o.x && this.y < o.y + o.height && this.y + this.height > o.y) {
                    return false;
                }
            }
            // æ£€æŸ¥ç¢°æ’
            const target = this.owner.isAI ? players[0] : players[1];
            if (this.checkCollision(target)) {
                this.owner.dealDamage(target, GAME_CONFIG.laserDamage);
                return false;
            }

            return true;
        }

        // é£é•–/æ¿€å…‰å‘½ä¸­éŸ³æ•ˆ
        Player.prototype.dealDamage = function(target, damage) {
            if (target.ultimateActive && target.ultimatePhase === 1) return;
            target.health = Math.max(0, target.health - damage);
            target.hitFlash = 10;
            createDamageText(target.x + target.width / 2, target.y, damage);
            createParticleExplosion(target.x + target.width / 2, target.y + target.height / 2);
            playSound('hitSound');
            if (target.health <= 0) {
                gameState.gameOver = true;
                gameState.winner = this.isAI ? 'AI' : 'ç©å®¶';
                setTimeout(() => {
                    playSound('victorySound');
                }, 200);
                showGameOver();
            }
        }

        // AIæŠ¢è¡€åŒ…ã€åˆ©ç”¨éšœç¢ç‰©
        Player.prototype.updateAI = function() {
            const player = gameState.isRunning ? players[0] : null;
            if (!player) return;

            this.aiTimer++;

            // æ ¹æ®éš¾åº¦è°ƒæ•´AIè¡Œä¸º
            const difficulty = gameState.settings.difficulty;
            let reactionTime = 30;
            let skillChance = 0.1;

            switch (difficulty) {
                case 'easy':
                    reactionTime = 60;
                    skillChance = 0.05;
                    break;
                case 'hard':
                    reactionTime = 15;
                    skillChance = 0.2;
                    break;
            }

            // è·ç¦»è®¡ç®—
            const distance = Math.abs(this.x - player.x);
            const direction = this.x < player.x ? 1 : -1;

            // AIçŠ¶æ€æœº
            switch (this.aiState) {
                case 'idle':
                    if (this.aiTimer > reactionTime) {
                        this.aiState = 'approach';
                        this.aiTimer = 0;
                    }
                    break;

                case 'approach':
                    // æ¥è¿‘ç©å®¶
                    this.velocityX = direction * GAME_CONFIG.playerSpeed;
                    this.facingRight = direction > 0;

                    // å¦‚æœè·ç¦»åˆé€‚ï¼Œåˆ‡æ¢åˆ°æ”»å‡»çŠ¶æ€
                    if (distance < 150 && distance > 50) {
                        this.aiState = 'attack';
                        this.aiTimer = 0;
                    }

                    // éšæœºè·³è·ƒ
                    if (Math.random() < 0.02 && this.onGround) {
                        this.jump();
                    }

                    // éšæœºä½¿ç”¨æŠ€èƒ½
                    if (Math.random() < skillChance) {
                        if (this.dartCooldown === 0 && distance > 80) {
                            this.shootDart();
                        } else if (this.teleportCooldown === 0) {
                            this.teleport();
                        } else if (this.ultimateCooldown === 0 && distance < 100) {
                            this.ultimate();
                        }
                    }
                    break;

                case 'attack':
                    // æ”»å‡»è¡Œä¸º
                    if (distance < 50) {
                        this.attack();
                    } else if (distance > 200) {
                        this.aiState = 'approach';
                    } else {
                        // ä¿æŒè·ç¦»
                        if (distance < 80) {
                            this.velocityX = -direction * GAME_CONFIG.playerSpeed;
                        } else if (distance > 120) {
                            this.velocityX = direction * GAME_CONFIG.playerSpeed;
                        }
                    }

                    // éšæœºè·³è·ƒèº²é¿
                    if (Math.random() < 0.03 && this.onGround) {
                        this.jump();
                    }

                    this.aiTimer++;
                    if (this.aiTimer > 120) {
                        this.aiState = 'idle';
                        this.aiTimer = 0;
                    }
                    break;
            }

            // ä¼˜å…ˆæŠ¢è¡€åŒ…
            if (healItems.length && this.health < this.maxHealth) {
                let nearest = healItems.reduce((a, b) => Math.abs(a.x-this.x)<Math.abs(b.x-this.x)?a:b);
                if (Math.abs(nearest.x - this.x) > 10) {
                    this.velocityX = nearest.x > this.x ? GAME_CONFIG.playerSpeed : -GAME_CONFIG.playerSpeed;
                    this.facingRight = nearest.x > this.x;
                }
                return;
            }

            // èº²é¿é£é•–
            darts.forEach(dart => {
                if (dart.owner !== this && Math.abs(dart.x - this.x) < 100 && Math.abs(dart.y - this.y) < 50) {
                    if (this.onGround && Math.random() < 0.1) {
                        this.jump();
                    }
                }
            });
        }

        // éŸ³é‡è°ƒèŠ‚
        let bgm = document.getElementById('bgm');
        let hitSound = document.getElementById('hitSound');
        let healSound = document.getElementById('healSound');
        let laserSound = document.getElementById('laserSound');
        let victorySound = document.getElementById('victorySound');
        let comboSound = document.getElementById('comboSound');
        let cooldownSound = document.getElementById('cooldownSound');
        let failSound = document.getElementById('failSound');
        function setVolume(vol) {
            bgm.volume = vol;
            hitSound.volume = vol;
            healSound.volume = vol;
            laserSound.volume = vol;
            victorySound.volume = vol;
            comboSound.volume = vol;
            cooldownSound.volume = vol;
            failSound.volume = vol;
        }

        // æ¯10ç§’åˆ·æ–°ä¸€ä¸ªè¡€åŒ…
        setInterval(() => {
            if (gameState.isRunning && healItems.length < 2) {
                createHealItem();
            }
        }, 10000);

        // æŠ€èƒ½å†·å´å®Œæ¯•æ—¶
        function checkSkillCooldowns() {
            if (players[0]) {
                if (players[0].dartCooldown === 0) playSound('cooldownSound');
                if (players[0].teleportCooldown === 0) playSound('cooldownSound');
                if (players[0].ultimateCooldown === 0) playSound('cooldownSound');
            }
        }
        setInterval(checkSkillCooldowns, 1000/30);

        // æ…¢åŠ¨ä½œå®ç°
        function slowMotion() {
            let old = GAME_CONFIG.gravity;
            GAME_CONFIG.gravity = 0.2;
            setTimeout(() => { GAME_CONFIG.gravity = old; }, 800);
        }

        // åˆå§‹åŒ–
        resizeCanvas();

        // è¾“å…¥å¤„ç†å¾ªç¯
        setInterval(handleInput, 16);

        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio.play();
            }
        }
    </script>
</body>
</html> 