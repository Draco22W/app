<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• ÁÅ´Êü¥‰∫∫ÊâìÊñóÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            cursor: crosshair;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .health-bars {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .health-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 8px;
            position: relative;
        }

        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: healthShine 2s infinite;
        }

        @keyframes healthShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .player1-health .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #ff4757);
        }

        .player2-health .health-fill {
            background: linear-gradient(90deg, #3742fa, #00d2ff);
        }

        .health-text {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 0 10px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #fff;
            font-size: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .controls h3 {
            margin-bottom: 8px;
            color: #ffd700;
        }

        .controls p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .skill-cooldowns {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .skill-cooldown {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .skill-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }

        .skill-icon.dart {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
        }

        .skill-icon.teleport {
            background: linear-gradient(45deg, #3742fa, #00d2ff);
        }

        .skill-icon.ultimate {
            background: linear-gradient(45deg, #ffd700, #ff6b35);
        }

        .cooldown-bar {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .cooldown-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.1s linear;
            border-radius: 3px;
        }

        .settings-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            backdrop-filter: blur(20px);
            display: none;
            pointer-events: auto;
            min-width: 300px;
        }

        .settings-menu h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .setting-item {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-item label {
            color: #fff;
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #444;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #ffd700;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .difficulty-select {
            background: #333;
            color: #fff;
            border: 1px solid #ffd700;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
            transition: transform 0.2s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            text-align: center;
            display: none;
            pointer-events: auto;
        }

        .game-over h2 {
            color: #ffd700;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .game-over p {
            color: #fff;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            display: block;
            pointer-events: auto;
        }

        .start-screen h1 {
            font-size: 48px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .start-screen p {
            font-size: 18px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .start-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .start-btn:hover {
            transform: scale(1.1);
        }

        .damage-text {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: particleExplode 0.8s ease-out forwards;
        }

        @keyframes particleExplode {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0) translate(var(--dx), var(--dy));
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div class="ui-overlay">
        <div class="health-bars">
            <div class="health-text">Áé©ÂÆ∂</div>
            <div class="health-bar player1-health">
                <div class="health-fill" style="width: 100%"></div>
            </div>
            <div class="health-text">AI</div>
            <div class="health-bar player2-health">
                <div class="health-fill" style="width: 100%"></div>
            </div>
        </div>

        <div class="controls">
            <h3>üéÆ Êìç‰ΩúËØ¥Êòé</h3>
            <p><strong>W</strong> - Ë∑≥Ë∑É</p>
            <p><strong>A/D</strong> - Â∑¶Âè≥ÁßªÂä®</p>
            <p><strong>I</strong> - È£ûÈïñÊîªÂáª</p>
            <p><strong>O</strong> - Áû¨ÁßªÊäÄËÉΩ</p>
            <p><strong>P</strong> - Â§ßÊãõÔºàÊó†Êïå+ÊøÄÂÖâÔºâ</p>
            <p><strong>ESC</strong> - ËÆæÁΩÆËèúÂçï</p>
        </div>

        <div class="skill-cooldowns">
            <div class="skill-cooldown">
                <div class="skill-icon dart">I</div>
                <div class="cooldown-bar">
                    <div class="cooldown-fill" style="width: 100%"></div>
                </div>
            </div>
            <div class="skill-cooldown">
                <div class="skill-icon teleport">O</div>
                <div class="cooldown-bar">
                    <div class="cooldown-fill" style="width: 100%"></div>
                </div>
            </div>
            <div class="skill-cooldown">
                <div class="skill-icon ultimate">P</div>
                <div class="cooldown-bar">
                    <div class="cooldown-fill" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="settings-menu">
            <h2>‚öôÔ∏è Ê∏∏ÊàèËÆæÁΩÆ</h2>
            <div class="setting-item">
                <label>Èü≥Êïà</label>
                <div class="toggle-switch" id="soundToggle"></div>
            </div>
            <div class="setting-item">
                <label>Èü≥‰πê</label>
                <div class="toggle-switch" id="musicToggle"></div>
            </div>
            <div class="setting-item">
                <label>AIÈöæÂ∫¶</label>
                <select class="difficulty-select" id="difficultySelect">
                    <option value="easy">ÁÆÄÂçï</option>
                    <option value="normal" selected>ÊôÆÈÄö</option>
                    <option value="hard">Âõ∞Èöæ</option>
                </select>
            </div>
            <button class="restart-btn" onclick="restartGame()">ÈáçÊñ∞ÂºÄÂßã</button>
        </div>

        <div class="game-over">
            <h2 id="gameOverTitle">Ê∏∏ÊàèÁªìÊùü</h2>
            <p id="gameOverMessage">Ëé∑ËÉúËÄÖ</p>
            <button class="restart-btn" onclick="restartGame()">ÂÜçÊù•‰∏ÄÂ±Ä</button>
        </div>

        <div class="start-screen" id="startScreen">
            <h1>üî• ÁÅ´Êü¥‰∫∫ÊâìÊñó</h1>
            <p>‰ΩøÁî®WASDÁßªÂä®ÔºåIÈîÆÈ£ûÈïñÔºåOÈîÆÁû¨ÁßªÔºåPÈîÆÂ§ßÊãõ</p>
            <button class="start-btn" onclick="startGame()">ÂºÄÂßãÊ∏∏Êàè</button>
        </div>
    </div>

    <script>
        // Ê∏∏ÊàèÈÖçÁΩÆ
        const GAME_CONFIG = {
            width: window.innerWidth,
            height: window.innerHeight,
            gravity: 0.8,
            groundY: window.innerHeight - 100,
            playerSpeed: 4,
            runSpeed: 6,
            jumpPower: 15,
            dartSpeed: 8,
            dartDamage: 15,
            meleeDamage: 10,
            teleportDistance: 100,
            ultimateCooldown: 2400, // 40ÁßíÂÜ∑Âç¥
            ultimateDuration: 300, // 5ÁßíÊó†ÊïåÊó∂Èó¥
            laserDamage: 25
        };

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            isRunning: false,
            isPaused: false,
            gameOver: false,
            winner: null,
            settings: {
                sound: true,
                music: true,
                difficulty: 'normal'
            }
        };

        // Ëé∑ÂèñÁîªÂ∏ÉÂíå‰∏ä‰∏ãÊñá
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Ë∞ÉÊï¥ÁîªÂ∏ÉÂ§ßÂ∞è
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            GAME_CONFIG.width = window.innerWidth;
            GAME_CONFIG.height = window.innerHeight;
            GAME_CONFIG.groundY = window.innerHeight - 100;
        }

        // Áé©ÂÆ∂Á±ª
        class Player {
            constructor(x, y, color, isAI = false) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 60;
                this.color = color;
                this.isAI = isAI;
                this.health = 100;
                this.maxHealth = 100;
                this.velocityX = 0;
                this.velocityY = 0;
                this.onGround = false;
                this.facingRight = !isAI;
                this.attacking = false;
                this.attackCooldown = 0;
                this.dartCooldown = 0;
                this.teleportCooldown = 0;
                this.ultimateCooldown = 0;
                this.ultimateActive = false;
                this.ultimateTimer = 0;
                this.ultimatePhase = 0; // 0: Êú™ÊøÄÊ¥ª, 1: Êó†ÊïåÁä∂ÊÄÅ, 2: ÊøÄÂÖâÁä∂ÊÄÅ
                this.animationFrame = 0;
                this.isRunning = false;
                this.isJumping = false;
                this.hitFlash = 0;
                this.lastAction = 0;
                this.aiState = 'idle';
                this.aiTimer = 0;
                this.targetX = x;
            }

            update() {
                // Êõ¥Êñ∞Âä®ÁîªÂ∏ß
                this.animationFrame++;
                
                // Â∫îÁî®ÈáçÂäõ
                if (!this.onGround) {
                    this.velocityY += GAME_CONFIG.gravity;
                }

                // Êõ¥Êñ∞‰ΩçÁΩÆ
                this.x += this.velocityX;
                this.y += this.velocityY;

                // Âú∞Èù¢Á¢∞ÊíûÊ£ÄÊµã
                if (this.y >= GAME_CONFIG.groundY - this.height) {
                    this.y = GAME_CONFIG.groundY - this.height;
                    this.velocityY = 0;
                    this.onGround = true;
                    this.isJumping = false;
                }

                // ËæπÁïåÊ£ÄÊµã
                if (this.x < 0) this.x = 0;
                if (this.x > GAME_CONFIG.width - this.width) {
                    this.x = GAME_CONFIG.width - this.width;
                }

                // Êõ¥Êñ∞ÂÜ∑Âç¥Êó∂Èó¥
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.dartCooldown > 0) this.dartCooldown--;
                if (this.teleportCooldown > 0) this.teleportCooldown--;
                if (this.ultimateCooldown > 0) this.ultimateCooldown--;

                // Êõ¥Êñ∞Â§ßÊãõÁä∂ÊÄÅ
                if (this.ultimateActive) {
                    this.ultimateTimer--;
                    if (this.ultimateTimer <= 0) {
                        this.ultimateActive = false;
                        this.ultimatePhase = 0;
                    }
                }

                // Êõ¥Êñ∞ÂèóÂáªÈó™ÁÉÅ
                if (this.hitFlash > 0) this.hitFlash--;

                // AIË°å‰∏∫
                if (this.isAI) {
                    this.updateAI();
                }

                // Êõ¥Êñ∞ÁßªÂä®Áä∂ÊÄÅ
                this.isRunning = Math.abs(this.velocityX) > 0;
            }

            updateAI() {
                const player = gameState.isRunning ? players[0] : null;
                if (!player) return;

                this.aiTimer++;

                // Ê†πÊçÆÈöæÂ∫¶Ë∞ÉÊï¥AIË°å‰∏∫
                const difficulty = gameState.settings.difficulty;
                let reactionTime = 30;
                let skillChance = 0.1;

                switch (difficulty) {
                    case 'easy':
                        reactionTime = 60;
                        skillChance = 0.05;
                        break;
                    case 'hard':
                        reactionTime = 15;
                        skillChance = 0.2;
                        break;
                }

                // Ë∑ùÁ¶ªËÆ°ÁÆó
                const distance = Math.abs(this.x - player.x);
                const direction = this.x < player.x ? 1 : -1;

                // AIÁä∂ÊÄÅÊú∫
                switch (this.aiState) {
                    case 'idle':
                        if (this.aiTimer > reactionTime) {
                            this.aiState = 'approach';
                            this.aiTimer = 0;
                        }
                        break;

                    case 'approach':
                        // Êé•ËøëÁé©ÂÆ∂
                        this.velocityX = direction * GAME_CONFIG.playerSpeed;
                        this.facingRight = direction > 0;

                        // Â¶ÇÊûúË∑ùÁ¶ªÂêàÈÄÇÔºåÂàáÊç¢Âà∞ÊîªÂáªÁä∂ÊÄÅ
                        if (distance < 150 && distance > 50) {
                            this.aiState = 'attack';
                            this.aiTimer = 0;
                        }

                        // ÈöèÊú∫Ë∑≥Ë∑É
                        if (Math.random() < 0.02 && this.onGround) {
                            this.jump();
                        }

                        // ÈöèÊú∫‰ΩøÁî®ÊäÄËÉΩ
                        if (Math.random() < skillChance) {
                            if (this.dartCooldown === 0 && distance > 80) {
                                this.shootDart();
                            } else if (this.teleportCooldown === 0) {
                                this.teleport();
                            } else if (this.ultimateCooldown === 0 && distance < 100) {
                                this.ultimate();
                            }
                        }
                        break;

                    case 'attack':
                        // ÊîªÂáªË°å‰∏∫
                        if (distance < 50) {
                            this.attack();
                        } else if (distance > 200) {
                            this.aiState = 'approach';
                        } else {
                            // ‰øùÊåÅË∑ùÁ¶ª
                            if (distance < 80) {
                                this.velocityX = -direction * GAME_CONFIG.playerSpeed;
                            } else if (distance > 120) {
                                this.velocityX = direction * GAME_CONFIG.playerSpeed;
                            }
                        }

                        // ÈöèÊú∫Ë∑≥Ë∑ÉË∫≤ÈÅø
                        if (Math.random() < 0.03 && this.onGround) {
                            this.jump();
                        }

                        this.aiTimer++;
                        if (this.aiTimer > 120) {
                            this.aiState = 'idle';
                            this.aiTimer = 0;
                        }
                        break;
                }

                // Ë∫≤ÈÅøÈ£ûÈïñ
                darts.forEach(dart => {
                    if (dart.owner !== this && Math.abs(dart.x - this.x) < 100 && Math.abs(dart.y - this.y) < 50) {
                        if (this.onGround && Math.random() < 0.1) {
                            this.jump();
                        }
                    }
                });
            }

            jump() {
                if (this.onGround) {
                    this.velocityY = -GAME_CONFIG.jumpPower;
                    this.onGround = false;
                    this.isJumping = true;
                }
            }

            attack() {
                if (this.attackCooldown === 0) {
                    this.attacking = true;
                    this.attackCooldown = 20;

                    // Ê£ÄÊµãÊîªÂáªÁ¢∞Êíû
                    const target = this.isAI ? players[0] : players[1];
                    const distance = Math.abs(this.x - target.x);
                    const direction = this.facingRight ? 1 : -1;
                    const attackRange = 60;

                    if (distance < attackRange && 
                        ((direction > 0 && target.x > this.x) || (direction < 0 && target.x < this.x))) {
                        this.dealDamage(target, GAME_CONFIG.meleeDamage);
                    }

                    setTimeout(() => {
                        this.attacking = false;
                    }, 200);
                }
            }

            shootDart() {
                if (this.dartCooldown === 0) {
                    const direction = this.facingRight ? 1 : -1;
                    const damage = this.ultimateActive && this.ultimatePhase === 1 ? 
                        GAME_CONFIG.dartDamage * 1.5 : GAME_CONFIG.dartDamage;
                    const dart = new Dart(
                        this.x + (this.facingRight ? this.width : 0),
                        this.y + this.height / 2,
                        direction,
                        this,
                        damage
                    );
                    darts.push(dart);
                    this.dartCooldown = 60; // 1ÁßíÂÜ∑Âç¥
                }
            }

            teleport() {
                if (this.teleportCooldown === 0) {
                    const direction = this.facingRight ? 1 : -1;
                    const newX = this.x + direction * GAME_CONFIG.teleportDistance;
                    
                    if (newX >= 0 && newX <= GAME_CONFIG.width - this.width) {
                        this.x = newX;
                        createTeleportEffect(this.x, this.y);
                    }
                    
                    this.teleportCooldown = 120; // 2ÁßíÂÜ∑Âç¥
                }
            }

            ultimate() {
                if (this.ultimateCooldown === 0) {
                    if (this.ultimatePhase === 0) {
                        // Á¨¨‰∏ÄÈò∂ÊÆµÔºöÊøÄÊ¥ªÊó†ÊïåÁä∂ÊÄÅ
                        this.ultimateActive = true;
                        this.ultimatePhase = 1;
                        this.ultimateTimer = GAME_CONFIG.ultimateDuration;
                        createUltimateEffect(this.x, this.y);
                    } else if (this.ultimatePhase === 1) {
                        // Á¨¨‰∫åÈò∂ÊÆµÔºöÂèëÂ∞ÑÊøÄÂÖâ
                        this.ultimatePhase = 2;
                        this.shootLaser();
                        this.ultimateActive = false;
                        this.ultimateCooldown = GAME_CONFIG.ultimateCooldown;
                    }
                }
            }

            shootLaser() {
                const direction = this.facingRight ? 1 : -1;
                const laser = new Laser(
                    this.x + (this.facingRight ? this.width : 0),
                    this.y + this.height / 2,
                    direction,
                    this
                );
                lasers.push(laser);
            }

            dealDamage(target, damage) {
                // Ê£ÄÊü•Êó†ÊïåÁä∂ÊÄÅ
                if (target.ultimateActive && target.ultimatePhase === 1) {
                    return; // Êó†ÊïåÁä∂ÊÄÅ‰∏çÂèó‰º§ÂÆ≥
                }

                target.health = Math.max(0, target.health - damage);
                target.hitFlash = 10;
                
                // ÂàõÂª∫‰º§ÂÆ≥Êï∞Â≠ó
                createDamageText(target.x + target.width / 2, target.y, damage);
                
                // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
                createParticleExplosion(target.x + target.width / 2, target.y + target.height / 2);
                
                // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
                if (target.health <= 0) {
                    gameState.gameOver = true;
                    gameState.winner = this.isAI ? 'AI' : 'Áé©ÂÆ∂';
                    showGameOver();
                }
            }

            draw() {
                ctx.save();
                
                // ÂèóÂáªÈó™ÁÉÅÊïàÊûú
                if (this.hitFlash > 0) {
                    ctx.globalAlpha = 0.5;
                }

                // Êó†ÊïåÁä∂ÊÄÅÊïàÊûú
                if (this.ultimateActive && this.ultimatePhase === 1) {
                    ctx.strokeStyle = '#ffd700';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.8;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 25, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // ËÆ°ÁÆóÂä®ÁîªËßíÂ∫¶
                let armAngle = 0;
                let legAngle = 0;

                // Â•îË∑ëÂä®Áîª
                if (this.isRunning) {
                    armAngle = Math.sin(this.animationFrame * 0.3) * 0.5;
                    legAngle = Math.sin(this.animationFrame * 0.4) * 0.6;
                }

                // Ë∑≥Ë∑ÉÂä®Áîª
                if (this.isJumping) {
                    legAngle = Math.PI / 6;
                }

                // ÊîªÂáªÂä®Áîª
                if (this.attacking) {
                    armAngle = Math.PI / 4;
                }

                // ÁªòÂà∂ÁÅ´Êü¥‰∫∫
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                // Â§¥ÈÉ®
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + 10, 8, 0, Math.PI * 2);
                ctx.stroke();

                // Ë∫´‰Ωì
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 18);
                ctx.lineTo(this.x + this.width / 2, this.y + 45);
                ctx.stroke();

                // ÊâãËáÇ
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 25);
                ctx.lineTo(this.x + this.width / 2 + Math.cos(armAngle) * 15, this.y + 25 + Math.sin(armAngle) * 15);
                ctx.moveTo(this.x + this.width / 2, this.y + 25);
                ctx.lineTo(this.x + this.width / 2 - Math.cos(armAngle) * 15, this.y + 25 - Math.sin(armAngle) * 15);
                ctx.stroke();

                // ËÖøÈÉ®
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + 45);
                ctx.lineTo(this.x + this.width / 2 + Math.cos(legAngle) * 15, this.y + 45 + Math.sin(legAngle) * 15);
                ctx.moveTo(this.x + this.width / 2, this.y + 45);
                ctx.lineTo(this.x + this.width / 2 - Math.cos(legAngle) * 15, this.y + 45 - Math.sin(legAngle) * 15);
                ctx.stroke();

                ctx.restore();
            }
        }

        // È£ûÈïñÁ±ª
        class Dart {
            constructor(x, y, direction, owner, damage = GAME_CONFIG.dartDamage) {
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.owner = owner;
                this.damage = damage;
                this.speed = GAME_CONFIG.dartSpeed;
                this.width = 8;
                this.height = 8;
            }

            update() {
                this.x += this.direction * this.speed;

                // Ê£ÄÊü•ËæπÁïå
                if (this.x < 0 || this.x > GAME_CONFIG.width) {
                    return false;
                }

                // Ê£ÄÊü•Á¢∞Êíû
                const target = this.owner.isAI ? players[0] : players[1];
                if (this.checkCollision(target)) {
                    this.owner.dealDamage(target, this.damage);
                    return false;
                }

                return true;
            }

            checkCollision(target) {
                return this.x < target.x + target.width &&
                       this.x + this.width > target.x &&
                       this.y < target.y + target.height &&
                       this.y + this.height > target.y;
            }

            draw() {
                ctx.save();
                ctx.fillStyle = this.owner.isAI ? '#3742fa' : '#ff6b6b';
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // È£ûÈïñËΩ®Ëøπ
                ctx.strokeStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + this.height / 2);
                ctx.lineTo(this.x + this.width / 2 - this.direction * 20, this.y + this.height / 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        // ÊøÄÂÖâÁ±ª
        class Laser {
            constructor(x, y, direction, owner) {
                this.x = x;
                this.y = y;
                this.direction = direction;
                this.owner = owner;
                this.speed = 15;
                this.width = 6;
                this.height = 6;
                this.life = 60; // 1ÁßíÊåÅÁª≠Êó∂Èó¥
            }

            update() {
                this.x += this.direction * this.speed;
                this.life--;

                // Ê£ÄÊü•ËæπÁïå
                if (this.x < 0 || this.x > GAME_CONFIG.width || this.life <= 0) {
                    return false;
                }

                // Ê£ÄÊü•Á¢∞Êíû
                const target = this.owner.isAI ? players[0] : players[1];
                if (this.checkCollision(target)) {
                    this.owner.dealDamage(target, GAME_CONFIG.laserDamage);
                    return false;
                }

                return true;
            }

            checkCollision(target) {
                return this.x < target.x + target.width &&
                       this.x + this.width > target.x &&
                       this.y < target.y + target.height &&
                       this.y + this.height > target.y;
            }

            draw() {
                ctx.save();
                
                // ÊøÄÂÖâÊ†∏ÂøÉ
                ctx.fillStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // ÊøÄÂÖâÂÖâÁéØ
                ctx.strokeStyle = this.owner.isAI ? '#3742fa' : '#ff6b6b';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 8, 0, Math.PI * 2);
                ctx.stroke();
                
                // ÊøÄÂÖâËΩ®Ëøπ
                ctx.strokeStyle = this.owner.isAI ? '#00d2ff' : '#ff4757';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.moveTo(this.x + this.width / 2, this.y + this.height / 2);
                ctx.lineTo(this.x + this.width / 2 - this.direction * 50, this.y + this.height / 2);
                ctx.stroke();
                
                ctx.restore();
            }
        }

        // Ê∏∏ÊàèÂØπË±°
        let players = [];
        let darts = [];
        let lasers = [];
        let damageTexts = [];
        let particles = [];

        // ÂàõÂª∫Áé©ÂÆ∂
        function createPlayers() {
            players = [
                new Player(100, GAME_CONFIG.groundY - 60, '#ff6b6b', false),
                new Player(GAME_CONFIG.width - 130, GAME_CONFIG.groundY - 60, '#3742fa', true)
            ];
        }

        // ÂàõÂª∫‰º§ÂÆ≥Êï∞Â≠ó
        function createDamageText(x, y, damage) {
            const text = {
                x: x,
                y: y,
                damage: damage,
                life: 60,
                velocityY: -2
            };
            damageTexts.push(text);
        }

        // ÂàõÂª∫Á≤íÂ≠êÁàÜÁÇ∏ÊïàÊûú
        function createParticleExplosion(x, y) {
            for (let i = 0; i < 8; i++) {
                const angle = (Math.PI * 2 * i) / 8;
                const speed = 3 + Math.random() * 2;
                const particle = {
                    x: x,
                    y: y,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 30 + Math.random() * 30,
                    maxLife: 60
                };
                particles.push(particle);
            }
        }

        // ÂàõÂª∫Áû¨ÁßªÊïàÊûú
        function createTeleportEffect(x, y) {
            for (let i = 0; i < 12; i++) {
                const angle = (Math.PI * 2 * i) / 12;
                const speed = 2 + Math.random() * 3;
                const particle = {
                    x: x + 15,
                    y: y + 30,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 20 + Math.random() * 20,
                    maxLife: 40,
                    color: '#00d2ff'
                };
                particles.push(particle);
            }
        }

        // ÂàõÂª∫Â§ßÊãõÊïàÊûú
        function createUltimateEffect(x, y) {
            for (let i = 0; i < 20; i++) {
                const angle = (Math.PI * 2 * i) / 20;
                const speed = 3 + Math.random() * 4;
                const particle = {
                    x: x + 15,
                    y: y + 30,
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    life: 30 + Math.random() * 30,
                    maxLife: 60,
                    color: '#ffd700'
                };
                particles.push(particle);
            }
        }

        // Êõ¥Êñ∞UI
        function updateUI() {
            // Êõ¥Êñ∞Ë°ÄÈáèÊù°
            const player1Health = document.querySelector('.player1-health .health-fill');
            const player2Health = document.querySelector('.player2-health .health-fill');
            
            if (players[0]) {
                player1Health.style.width = (players[0].health / players[0].maxHealth * 100) + '%';
            }
            if (players[1]) {
                player2Health.style.width = (players[1].health / players[1].maxHealth * 100) + '%';
            }

            // Êõ¥Êñ∞ÊäÄËÉΩÂÜ∑Âç¥
            const dartCooldown = document.querySelector('.skill-cooldown:nth-child(1) .cooldown-fill');
            const teleportCooldown = document.querySelector('.skill-cooldown:nth-child(2) .cooldown-fill');
            const ultimateCooldown = document.querySelector('.skill-cooldown:nth-child(3) .cooldown-fill');
            
            if (players[0]) {
                const dartPercent = Math.max(0, (60 - players[0].dartCooldown) / 60 * 100);
                const teleportPercent = Math.max(0, (120 - players[0].teleportCooldown) / 120 * 100);
                const ultimatePercent = Math.max(0, (GAME_CONFIG.ultimateCooldown - players[0].ultimateCooldown) / GAME_CONFIG.ultimateCooldown * 100);
                
                dartCooldown.style.width = dartPercent + '%';
                teleportCooldown.style.width = teleportPercent + '%';
                ultimateCooldown.style.width = ultimatePercent + '%';
            }
        }

        // ÁªòÂà∂Âú∞Èù¢
        function drawGround() {
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, GAME_CONFIG.groundY, GAME_CONFIG.width, GAME_CONFIG.height - GAME_CONFIG.groundY);
            
            // Âú∞Èù¢Á∫πÁêÜ
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 1;
            for (let i = 0; i < GAME_CONFIG.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, GAME_CONFIG.groundY);
                ctx.lineTo(i, GAME_CONFIG.height);
                ctx.stroke();
            }
        }

        // ÁªòÂà∂Á≤íÂ≠ê
        function drawParticles() {
            particles.forEach((particle, index) => {
                particle.x += particle.velocityX;
                particle.y += particle.velocityY;
                particle.life--;

                if (particle.life <= 0) {
                    particles.splice(index, 1);
                    return;
                }

                const alpha = particle.life / particle.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = particle.color || '#ffd700';
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // ÁªòÂà∂‰º§ÂÆ≥Êï∞Â≠ó
        function drawDamageTexts() {
            damageTexts.forEach((text, index) => {
                text.y += text.velocityY;
                text.life--;

                if (text.life <= 0) {
                    damageTexts.splice(index, 1);
                    return;
                }

                const alpha = text.life / 60;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = '#ff4757';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text.damage.toString(), text.x, text.y);
                ctx.restore();
            });
        }

        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        function gameLoop() {
            if (!gameState.isRunning || gameState.isPaused) return;

            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);

            // ÁªòÂà∂ËÉåÊôØ
            drawGround();

            // Êõ¥Êñ∞ÂíåÁªòÂà∂Áé©ÂÆ∂
            players.forEach(player => {
                player.update();
                player.draw();
            });

            // Êõ¥Êñ∞ÂíåÁªòÂà∂È£ûÈïñ
            darts = darts.filter(dart => dart.update());
            darts.forEach(dart => dart.draw());

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÊøÄÂÖâ
            lasers = lasers.filter(laser => laser.update());
            lasers.forEach(laser => laser.draw());

            // ÁªòÂà∂Á≤íÂ≠êÊïàÊûú
            drawParticles();

            // ÁªòÂà∂‰º§ÂÆ≥Êï∞Â≠ó
            drawDamageTexts();

            // Êõ¥Êñ∞UI
            updateUI();

            // ÁªßÁª≠Âæ™ÁéØ
            requestAnimationFrame(gameLoop);
        }

        // ÈîÆÁõòÊéßÂà∂
        const keys = {};

        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;

            if (e.key === 'Escape') {
                toggleSettings();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // Â§ÑÁêÜÁé©ÂÆ∂ËæìÂÖ•
        function handleInput() {
            if (!gameState.isRunning || !players[0]) return;

            const player = players[0];

            // ÁßªÂä®ÊéßÂà∂
            if (keys['a']) {
                player.velocityX = -GAME_CONFIG.playerSpeed;
                player.facingRight = false;
            } else if (keys['d']) {
                player.velocityX = GAME_CONFIG.playerSpeed;
                player.facingRight = true;
            } else {
                player.velocityX = 0;
            }

            // Â•îË∑ë
            if (keys['a'] || keys['d']) {
                player.velocityX *= 1.5;
            }

            // Ë∑≥Ë∑É
            if (keys['w']) {
                player.jump();
            }

            // ÊîªÂáª
            if (keys[' ']) {
                player.attack();
            }

            // ÊäÄËÉΩ
            if (keys['i']) {
                player.shootDart();
            }

            if (keys['o']) {
                player.teleport();
            }

            if (keys['p']) {
                player.ultimate();
            }
        }

        // ËÆæÁΩÆËèúÂçïÊéßÂà∂
        function toggleSettings() {
            const settingsMenu = document.querySelector('.settings-menu');
            if (settingsMenu.style.display === 'block') {
                settingsMenu.style.display = 'none';
                gameState.isPaused = false;
            } else {
                settingsMenu.style.display = 'block';
                gameState.isPaused = true;
            }
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùü
        function showGameOver() {
            const gameOver = document.querySelector('.game-over');
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');

            title.textContent = 'Ê∏∏ÊàèÁªìÊùü';
            message.textContent = `${gameState.winner} Ëé∑ËÉúÔºÅ`;

            gameOver.style.display = 'block';
            gameState.isPaused = true;
        }

        // ÂºÄÂßãÊ∏∏Êàè
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameState.isRunning = true;
            gameState.gameOver = false;
            gameState.winner = null;
            
            createPlayers();
            darts = [];
            lasers = [];
            damageTexts = [];
            particles = [];
            
            gameLoop();
        }

        // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
        function restartGame() {
            document.querySelector('.settings-menu').style.display = 'none';
            document.querySelector('.game-over').style.display = 'none';
            
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.gameOver = false;
            gameState.winner = null;
            
            createPlayers();
            darts = [];
            lasers = [];
            damageTexts = [];
            particles = [];
            
            gameLoop();
        }

        // ËÆæÁΩÆÂàáÊç¢
        document.getElementById('soundToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            gameState.settings.sound = this.classList.contains('active');
        });

        document.getElementById('musicToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            gameState.settings.music = this.classList.contains('active');
        });

        document.getElementById('difficultySelect').addEventListener('change', function() {
            gameState.settings.difficulty = this.value;
        });

        // ÂàùÂßãÂåñËÆæÁΩÆ
        document.getElementById('soundToggle').classList.add('active');
        document.getElementById('musicToggle').classList.add('active');

        // Á™óÂè£Â§ßÂ∞èË∞ÉÊï¥
        window.addEventListener('resize', resizeCanvas);

        // ÂàùÂßãÂåñ
        resizeCanvas();

        // ËæìÂÖ•Â§ÑÁêÜÂæ™ÁéØ
        setInterval(handleInput, 16);
    </script>
</body>
</html> 